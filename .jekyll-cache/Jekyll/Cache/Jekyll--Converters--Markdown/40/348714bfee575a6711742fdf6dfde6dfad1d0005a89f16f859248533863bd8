I"V<img src="/assets/Reaper/LuaTut/Tut.jpg" alt="Lua Code">
<div class="image-caption">Lua Code</div>

<p>Today we’re going to learn to write ReaScript, specifically Lua.</p>

<p><strong>If you’ve never programmed in your life</strong>, I’m going to try to take you from that point to your very first script with a GUI.</p>

<p>This isn’t a super trivial example either! This is a useful script that lets you create sidechaining via automation items.</p>

<p><strong>THIS IS A LOT OF READING!</strong>. You do not need to do it all at once. Try it in sections, <strong>take a break</strong> if you need to, and come back another time. Programming takes time to learn, and time to do. Don’t force it all on yourself at once.</p>

<p>I’ve a video walking you through it as well. Let’s get on with it…</p>

<!--more-->

<p><strong>If you have any questions or comments, please comment below! I read every comment and respond to most.</strong> No registration is necessary to comment, so don’t be shy.</p>

<h1 class="no_toc" id="contents">Contents</h1>
<ul id="markdown-toc">
  <li><a href="#special-thanks" id="markdown-toc-special-thanks">Special Thanks</a></li>
  <li><a href="#dragon---speech-to-text" id="markdown-toc-dragon---speech-to-text">Dragon - Speech to Text</a></li>
  <li><a href="#video" id="markdown-toc-video">Video</a></li>
  <li><a href="#what-is-reascript" id="markdown-toc-what-is-reascript">What is Reascript</a></li>
  <li><a href="#what-things-mean" id="markdown-toc-what-things-mean">What things mean</a></li>
  <li><a href="#the-script" id="markdown-toc-the-script">The Script</a></li>
  <li><a href="#expert-tutorial" id="markdown-toc-expert-tutorial">Expert Tutorial</a></li>
  <li><a href="#beginner-prerequisites" id="markdown-toc-beginner-prerequisites">Beginner Prerequisites</a>    <ul>
      <li><a href="#sws" id="markdown-toc-sws">SWS</a></li>
      <li><a href="#reapack" id="markdown-toc-reapack">Reapack</a>        <ul>
          <li><a href="#using-reapack" id="markdown-toc-using-reapack">Using ReaPack</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#beginner-tutorial-part-1---concepts" id="markdown-toc-beginner-tutorial-part-1---concepts">Beginner Tutorial Part 1 - Concepts</a>    <ul>
      <li><a href="#variables---storing-things" id="markdown-toc-variables---storing-things">Variables - Storing things</a>        <ul>
          <li><a href="#types---what-things-are" id="markdown-toc-types---what-things-are">Types - What things are</a></li>
        </ul>
      </li>
      <li><a href="#tables---storing-many-things" id="markdown-toc-tables---storing-many-things">Tables - Storing many things</a></li>
      <li><a href="#functions---doing-things" id="markdown-toc-functions---doing-things">Functions - Doing things</a></li>
      <li><a href="#comments---annotating-things" id="markdown-toc-comments---annotating-things">Comments - Annotating things</a></li>
      <li><a href="#scope---seeing-things" id="markdown-toc-scope---seeing-things">Scope - Seeing things</a></li>
      <li><a href="#conditionals---what-if" id="markdown-toc-conditionals---what-if">Conditionals - What if?</a></li>
      <li><a href="#loops---repeating-things" id="markdown-toc-loops---repeating-things">Loops - Repeating things</a></li>
      <li><a href="#libraries---using-other-peoples-functions" id="markdown-toc-libraries---using-other-peoples-functions">Libraries - Using other people’s functions</a></li>
    </ul>
  </li>
  <li><a href="#beginner-tutorial-part-2---programming-in-reaper" id="markdown-toc-beginner-tutorial-part-2---programming-in-reaper">Beginner Tutorial Part 2 - Programming in Reaper</a>    <ul>
      <li><a href="#how-to-try-code" id="markdown-toc-how-to-try-code">How to try code</a></li>
      <li><a href="#editing-code" id="markdown-toc-editing-code">Editing code</a></li>
      <li><a href="#where-to-find-information" id="markdown-toc-where-to-find-information">Where to find information</a>        <ul>
          <li><a href="#how-to-interpret-that-page" id="markdown-toc-how-to-interpret-that-page">How to interpret that page</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#beginner-tutorial-part-3---writing-the-script" id="markdown-toc-beginner-tutorial-part-3---writing-the-script">Beginner Tutorial Part 3 - Writing the script</a>    <ul>
      <li><a href="#get-information" id="markdown-toc-get-information">Get information</a></li>
      <li><a href="#safety" id="markdown-toc-safety">Safety</a></li>
      <li><a href="#looping-over-items" id="markdown-toc-looping-over-items">Looping over items</a></li>
      <li><a href="#create-automation-items" id="markdown-toc-create-automation-items">Create Automation Items</a></li>
      <li><a href="#setting-a-length" id="markdown-toc-setting-a-length">Setting a length</a></li>
      <li><a href="#put-it-all-together" id="markdown-toc-put-it-all-together">Put it all together</a></li>
    </ul>
  </li>
  <li><a href="#beginner-tutorial-part-3---making-a-gui" id="markdown-toc-beginner-tutorial-part-3---making-a-gui">Beginner Tutorial Part 3 - Making a GUI</a>    <ul>
      <li><a href="#gui-builder" id="markdown-toc-gui-builder">GUI Builder</a></li>
      <li><a href="#build-the-gui" id="markdown-toc-build-the-gui">Build the GUI</a></li>
      <li><a href="#use-the-gui" id="markdown-toc-use-the-gui">Use the GUI</a></li>
      <li><a href="#make-the-buttons-work" id="markdown-toc-make-the-buttons-work">Make the buttons work</a></li>
      <li><a href="#interact-with-the-gui---get_track" id="markdown-toc-interact-with-the-gui---get_track">Interact with the GUI - get_track</a></li>
      <li><a href="#interact-with-the-gui---get_envelope" id="markdown-toc-interact-with-the-gui---get_envelope">Interact with the GUI - get_envelope</a></li>
      <li><a href="#clear-the-selected-track-and-envelope" id="markdown-toc-clear-the-selected-track-and-envelope">Clear the selected track and envelope</a></li>
      <li><a href="#get-the-length" id="markdown-toc-get-the-length">Get the length</a></li>
      <li><a href="#update-main" id="markdown-toc-update-main">Update Main</a></li>
      <li><a href="#end" id="markdown-toc-end">End</a></li>
    </ul>
  </li>
  <li><a href="#mpls-awesome-code" id="markdown-toc-mpls-awesome-code">MPL’s awesome code</a></li>
  <li><a href="#more-resources" id="markdown-toc-more-resources">More Resources</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
  <li><a href="#support-me" id="markdown-toc-support-me">Support Me!</a></li>
</ul>

<h1 id="special-thanks">Special Thanks</h1>

<p>Before we start, I want to thank Justin of <a href="https://www.cockos.com">Cockos</a>. Without <a href="https://forum.cockos.com/showthread.php?t=196794">his surprisingly timely support</a> this entire post wouldn’t be possible.</p>

<p>Thank you to <a href="http://soundbytesmag.net/interviewwithmariokruselj/">Evildragon</a> for helping proofread, I really needed it this time. :) (<a href="#dragon---speech-to-text">there is some irony here…</a>)</p>

<p><a href="https://forum.cockos.com/member.php?u=10417">Lokasenna</a> for his GUI Library, <a href="https://forum.cockos.com/showthread.php?t=165040">constant contributions</a> to the <a href="https://forum.cockos.com/showthread.php?t=186637">REAPER community</a> and pleasant chats.</p>

<p><a href="https://www.extremraym.com/en/">X-Raym</a> and his fantastic website full of ReaScript resources and scripts for REAPER. He also helped me proofread and improve this article.</p>

<p>Jon @ <a href="https://reaperblog.net">The REAPER Blog</a> for giving me an incredible community resource to utilize.</p>

<p><a href="https://github.com/cfillion">CFillion</a> for his amazing work on <a href="https://reapack.com">ReaPack</a> and a variety of important REAPER projects.</p>

<p><a href="https://github.com/MichaelPilyavskiy/ReaScripts">MPL</a> for his demonstration of an advanced script that shows what REAPER is capable of and offers a more elegant solution to this use-case. Check out the <a href="/ReaperScripts.html">Reaper Script Showcase</a> to see many more of his amazing scripts. (Many of them replicate features from other DAWs that are paid add-ons, but he does it better!)</p>

<h1 id="dragon---speech-to-text">Dragon - Speech to Text</h1>

<p>This entire post, including the code, was written using <a href="https://www.nuance.com/dragon/dragon-for-mac/software.html">Dragon for Mac v6</a>.</p>

<p>I have developed a number of vocalizations that allow me to create common programming syntax, plus I have a number of snippets that I used in <a href="https://code.visualstudio.com">Visual Studio Code</a>.</p>

<p>I normally write my blog posts <a href="https://www.gnu.org/software/emacs/">in emacs</a>, however Dragon does not like typing words into Emacs. I have had a good deal of luck using VS code, however there are occasionally some issues</p>

<p>If you have ever wondered how well the speech to text software works, like Dragon, then let this be a demonstration. I have been using Dragon for nearly all of my text for the last week now and it has been incredibly accurate. I can edit the vocabulary and create custom commands that let me do nearly anything I want.</p>

<p>I was even able to feed it a number of my blog posts to start out, and it built a vocabulary based on things that I commonly write. Thusly I could write things like REAPER, Cubase, VST or FLStudio without ever having to train the software.</p>

<p>Due to the amount of pain that I have had in my arm and my hand this has been an incredible addition to my software arsenal. if you have ever been curious about speech to text software I can wholeheartedly recommend Dragon. It does require some set up, and you will need to spend some time adding the commands you need, but out-of-the-box it does an amazing job of voice recognition without any training or any set up.</p>

<p>Without Dragon, I do not think I would have been able to write this post at all, or it would have taken me literally weeks due to number of long pauses I would have to take while typing.</p>

<h1 id="video">Video</h1>

<iframe width="800" height="450" src="https://www.youtube.com/embed/Z-tlfoHeCIc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<p>This entire lesson (mostly) is available on youtube as a ~39 minute produced video (not just rambling while someone fumbles around).</p>

<h1 id="what-is-reascript">What is Reascript</h1>

<p>ReaScript is a generalized word that refers to miniature programs that can control REAPER. There are various computer programming languages that can be used to do this: Python, Lua and EEL.</p>

<p>There is also an API for C.</p>

<p>In this tutorial we will be using Lua to create a script that creates new automation items in the envelope lane that correspond to edits in media items. This will become more clear as I show the results of the script.</p>

<p>Don’t fear, I will be leading you through everything as if you have no clue how to program or how to use REAPER.</p>

<h1 id="what-things-mean">What things mean</h1>

<ul>
  <li><code class="highlighter-rouge">this is code</code> - code is like this</li>
  <li>“variable” - when I <a href="#variables---storing-things">refer to a variable in the code</a>, it will be in double quotes.</li>
</ul>

<p>I also put REAPER shortcuts <code class="highlighter-rouge">inside of these</code>. It should be clear when something is a shortcut, or if it’s code.</p>

<h1 id="the-script">The Script</h1>

    <video autoplay loop muted class="gifvid">
        <source src="/assets/Reaper/LuaTut/WorkingScript.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="video-caption">The working script</div>

<p>“Sidechaining” is a a techinque people use for having the content of one track affect another. You’ll have a transient item like a kick drum, and a non-transient item like a bass that occupy the same sonic space. You want the bass to be turned down for a short period of time when the kick hits. This lets the kick be full sounding without clashing with the bass sound.</p>

<p>REAPER has a concept called automation items. These are items that encapsulate automation so that you can:</p>

<ul>
  <li>Move the automation around and apply transformations to it (such as changing the shape) independently</li>
  <li>“Pool” automation items. This allows you to have encapsulated automation anywhere in your project that is mirrored. If you change one of the items, all of the other items change the exact same.
    <ul>
      <li>These pooled items can be <em>anywhere</em> on an automation envelope. You can have pooled items on pan, volume, VST effect etc… all at the same time, and they all have the same data.</li>
    </ul>
  </li>
</ul>

<p>This script requires that you’ve split your audio part (using the menu item “View-&gt;Dynamic split”).</p>

<p>When the item is split, you will have new items that have the start of the item right at the transient.</p>

<p>Our script will get all of the items on the selected track then create new automation items on the selected envelope. The automation items will have matching start times to the items, and a configurable length.</p>

<p>This setup allows you to edit the automation items to have a custom shape to sidechain whatever you want. It also alllows you to individually shift parts, or shift all of the automation items at once.</p>

<h1 id="expert-tutorial">Expert Tutorial</h1>

<p>Here’s the things that you need:</p>

<ul>
  <li><a href="https://reapack.com">ReaPack</a></li>
  <li><a href="http://www.sws-extension.org">SWS</a></li>
  <li>Lokasenna’s GUI library v2 for Lua - Install via ReaPack</li>
  <li>Lokasenna’s GUI library v2 for Lua (developer tools) - Install via ReaPack</li>
  <li>Script: Set Lokasenna_GUI v2 library path.lua - this must be run before any of the GUI Library</li>
</ul>

<p>In order to find the documentation for REAPER, open REAPER then goto the menu “Help-&gt;ReaScript Documentation”. <a href="https://www.extremraym.com/cloud/reascript-doc/">Better yet, go here</a> for better formatted documentation.</p>

<p>You can edit code in any editor you want like <a href="https://github.com/tbastos/vim-lua">vim</a>, <a href="https://github.com/immerrr/lua-mode">emacs</a>, <a href="https://plugins.jetbrains.com/plugin/5055-lua">Intellij</a>, <a href="https://packagecontrol.io/packages/LuaExtended">Sublime Text</a> and…</p>

<p>Lokasenna has some fantastic <a href="https://github.com/jalovatt/reaper-vs-code">extensions for VS Code</a> that give you a bunch of snippets, highlighting and API documentation inline.</p>

<p>Jump <a href="#beginner-tutorial-part-3---making-a-gui">to the GUI section</a> to see how GUIs are done. There are a few other GUI Widget libraries, but Lokasennas is the most complete that I’m aware of. You can also find a number of examples insides your Reaper <code class="highlighter-rouge">Scripts/ReaTeam Scripts/Development/Lokasenna_GUI v2/Developer Tools/Examples and Templates</code> directory. (also available <a href="https://github.com/ReaTeam/ReaScripts/tree/master/Development/Lokasenna_GUI%20v2/Developer%20Tools/Examples%20and%20Templates">on github</a>)</p>

<p>There is some digging you may need to do in order to understand how to use some functions, but general it’s only a cycle of two of feeding a function some garbage data to get an error message and be pointed in the right direction.</p>

<h1 id="beginner-prerequisites">Beginner Prerequisites</h1>

<p>In order to be able to do this there are two things that you will need, you will need Reapack and you will need SWS.</p>

<h2 id="sws">SWS</h2>

<p>REAPER’s bare functionality is lacking sometimes. There’s a bunch of functions that can be added to REAPER that are necessary for certain scripts, or necessary for bare functionality.</p>

<p><a href="http://www.sws-extension.org">SWS Extensions</a> provides a great deal of extra capability to REAPER and it acts as a <a href="#libraries---using-other-peoples-functions">library</a> to give the programmer extra functions to use. These functions are automatically added to the <a href="#where-to-find-information">ReaScript Docs</a>.</p>

<p>Once it is installed you will see a new menu in REAPER named “Extensions”. If you do not see that window, then please utilize google and the <a href="https://www.cockos.com/reaper/forum.php">REAPER forums</a> to see what you may have done wrong.</p>

<h2 id="reapack">Reapack</h2>

<img src="/assets/Reaper/LuaTut/ReaPack.jpg" alt="ReaPack">
<div class="image-caption">ReaPack</div>

<p><a href="https://reapack.com">ReaPack</a> allows you to install <a href="#libraries---using-other-peoples-functions">Libraries</a> and other people’s scripts.</p>

<p>Follow <a href="https://reapack.com/user-guide">the directions</a> to install it.</p>

<p>Once it is installed you will see a menu inside “Extensions” named “ReaPack”. Click “Browse packages” to see the window above.</p>

<h3 id="using-reapack">Using ReaPack</h3>

    <video autoplay loop muted class="gifvid">
        <source src="/assets/Reaper/LuaTut/ReaPackInstall.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="video-caption">Installing Packages with ReaPack</div>

<p>Installing with ReaPack is <em>slightly</em> tricky. You right click a package and select “Install”, but <strong>that does not install the package</strong>. You need to select the packages to install <em>then hit</em> “apply”.</p>

<p>Explore the interface and see what else you can do with it.</p>

<h1 id="beginner-tutorial-part-1---concepts">Beginner Tutorial Part 1 - Concepts</h1>

<p>Before we start actually writing some code let’s go over some basics of programming. I’m going to assume that you have never programmed in your life, and that you can just barely operate REAPER.</p>

<p>This tutorial is only written in the context of Lua for REAPER. Some of these concepts don’t apply necessarily to other languages.</p>

<p>You will need to read this tutorial at least twice if you are a total beginner. The concepts presented won’t make much sense until you see them in action, then you will need to go back and read about the concepts again and see them in action again.</p>

<p>You can try all of the examples here by going to <a href="https://repl.it/languages/lua">repl.it</a>, pasting the code and hitting the “run” button.</p>

<p>As the tutorial progresses, you will learn to use REAPER for this task.</p>

<p><strong>If you do not understand the first time then please make sure to read the entire thing all the way through at least twice</strong></p>

<h2 id="variables---storing-things">Variables - Storing things</h2>

<p>Computer software generally deals with two things: doing things to data, and dealing with events generated by outside sources like users.</p>

<p>When your program encounters new data then it needs to store it somewhere, and you need a way to reference that data sometime in the future.</p>

<p>You will also sometimes need to create your own data that is included in the software (such as pre-defined settings for your script), and you will want to reference this data by some sort of name.</p>

<p>This is what variables allow you to do: store data, and then refer to it at some other point in time by a name.</p>

<p>Let’s look at some code:</p>

<p><code class="highlighter-rouge">a = 1</code></p>

<p>In that line we declare a variable named “a”, and it is assigned a value of one. Anywhere we use the letter “a” it will be just like using the number one. So let’s look at that more.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I assume that you can guess what the value of “c” is.</p>

<p>Variables in Lua can store any data that we want. It can be words, they can be numbers, and variables can even hold things like <a href="#functions---doing-things">functions</a>.</p>

<p>So when there is some data that you want to save and refer to later, then you assign it to a variable.</p>

<h3 id="types---what-things-are">Types - What things are</h3>

<p>Data comes in a variety of types. This data can be numbers, strings (words), functions and other types of data that were not going to worry about right now.</p>

<p>(“String” is just a fancy word for alphanumeric characters that don’t explicitly reference numbers or other data.)</p>

<p>You can assign any type of data to any variable in Lua, however sometimes you will need to use a specific type of data such as a number or a string.</p>

<p><code class="highlighter-rouge">nil</code> is a special type of data in Lua. It simply means, “nothing at all”. It is also read as a “false” value, <a href="#conditionals---what-if">which you well learn later</a>.</p>

<p>We will only be working with numbers, strings and <code class="highlighter-rouge">nil</code> in this (explicitly at least. The only things you will need to know are how to convert between strings and numbers.)</p>

<h2 id="tables---storing-many-things">Tables - Storing many things</h2>

<p>Lua has a concept called tables, which is how you can store many things in a single variable.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">numbers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"one"</span><span class="p">,</span> <span class="s2">"two"</span><span class="p">,</span> <span class="s2">"four"</span><span class="p">,</span> <span class="s2">"three"</span><span class="p">}</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The variable “numbers” is storing four strings.</p>

<p>If we want to access one of them then we use the variables name, and square brackets with the index of the value we wish to use. So “numbers[1]” will get the first thing in our table.</p>

<p>I’m assuming that you can guess what “numbers[3]” will return, right? Be careful and look closely!</p>

<p>When we want to process an entire table, item by item, then we use <a href="#loops---repeating-things">loops</a>.</p>

<h2 id="functions---doing-things">Functions - Doing things</h2>

<p>In Lua for REAPER your entire script will be put inside what is called a function named “main()”. This is not necessary, but it is a tidier way to work.</p>

<p>Functions are how you do things. A function will contain variable assignments, <a href="#loops---repeating-things">loops</a>, <a href="#conditionals---what-if">conditionals</a> and calls to other functions. Let’s look at what a function looks like:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">add_a_and_b</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In this function we assigned two variables, then assigned a third variable which was the addition of the first two variables.</p>

<p>Lua understands what belongs to the function due to the <code class="highlighter-rouge">end</code> statement. Code is read more often than it is written, so we try to make this easier by <em>indenting</em> the things that belong to the function. As you can see, this makes it more obvious what things are “inside of the function”. Indentation is actually a complex topic(!!??), the only thing that is <em>really</em> important is that you are consistent with your style.</p>

<p>If we wanted to use this function, then we need to “call it”. When you call a function then the program jumps to that section of code and does everything inside that function block. Let’s see what that looks like:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">add_a_and_b</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">end</span>

<span class="n">add_a_and_b</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The line with <code class="highlighter-rouge">function</code> doesn’t do anything but declare the function as something that exists. If we want to use the function then we need to write <code class="highlighter-rouge">add_a_and_b()</code>.</p>

<p>That is not very useful though. We will want the function to interact with the outside world. It will need to take in its own data, and produce new data.</p>

<p>To give data to a function we use a feature called “arguments”.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">end</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We no longer need to assign A and B to variables. When we call the function with <code class="highlighter-rouge">add(1, 2)</code> we are telling it that we want A to equal 1 and B to equal 2. Look at where we declare the function and where we call the function.</p>

<p>We are still missing a piece here though. If we send data to a function then it would stand to reason that we would also want to sometimes get data back from a function. There is a special word we use, <code class="highlighter-rouge">return</code>. Let’s see that in action…</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">c</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>When the function is called then we add “a” and “b”, assign it to “c and then we <code class="highlighter-rouge">return c</code>. That means that we can call the function, and immediately assign the result of the function to another variable.</p>

<p>Remember, the line with <code class="highlighter-rouge">function</code> only says ‘Here I am!’. The line <code class="highlighter-rouge">print(add(1, 2))</code> is where the function is called, and there are 2 things happening:</p>

<ul>
  <li>Things are processed from the most inner-most (). So this means that <code class="highlighter-rouge">add(1, 2)</code> is processed.
    <ul>
      <li><code class="highlighter-rouge">add(1, 2)</code> returns a value of 3.</li>
    </ul>
  </li>
  <li>Now <code class="highlighter-rouge">print()</code> is called. It sees a value of 3, and it prints that.</li>
</ul>

<p>Where did <code class="highlighter-rouge">print()</code> come from though? This is a function built-in to Lua that lets us print things to the screen. It’s not something that we use in ReaScripts, but while we are learning the the basic of Lua it’s perfect. <a href="#editing-code">You will learn REAPER’s equivalent of the print() statement later</a></p>

<h2 id="comments---annotating-things">Comments - Annotating things</h2>

<p>Programming is not just about writing code, but about reading it as well.</p>

<p>In order to write a line that is not interpreted as code then place two hyphens in front of it.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="c1">-- This is a comment</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you want to have a comment that spans multiple lines then each line needs to have two hyphens in front of it or you can use this syntax:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cm">--[[
    Everything here
    Is a comment
]]</span><span class="c1">--</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Comments aren’t just for writing notes for yourself, or for somebody who might read your code. Comments can be used to temporarily disable parts of your code. If you have a portion of code that is no longer needed, or if you want to disable something so that you can test something, then use comments.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cm">--[[
    function add(a, b)
        c = a + b
        return c
    end

    result = add(1, 2)

    None of this does anything! It's all a comment.
]]</span><span class="c1">--</span>

<span class="c1">-- c = 1 + 2 </span>
<span class="c1">-- that last line was a comment too.</span>
<span class="c1">-- there is no working code here at all!</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="scope---seeing-things">Scope - Seeing things</h2>

<p>Imagine for a moment that you are making a script in REAPER that deals with moving items around. Often you will want to store the position of an item inside of a function. You may have many functions that move items around or store the position of an item.</p>

<p>So you may want to use a variable named “item_position”. That’s great, but if function “a()” uses “item_position” and function “b()” uses “item_position”, but the two functions need to store different values then what happens?</p>

<p>If you simply declare a variable in Lua, then it is visible to the entire program. If you want a variable to only be seen by the enclosing block (such as a function, <a href="#conditionals---what-if">conditional</a>, <a href="#loops---repeating-things">loops</a>, etc… almost anything with an ‘end’) then you need to put the word “local” in front of it.</p>

<p>Let’s try this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">function</span> <span class="nf">global_test</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">global_test</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is a slightly tricky one. The function <code class="highlighter-rouge">global_test()</code> can see the variables “a” and “b” because they are what is called ‘global’. Any function can see them, and any function can change them.</p>

<p>The trick here is that even though “c” is declared inside a function, it is also able to be seen from outside the function!</p>

<p>Let’s try to make “c” only visible to the function <code class="highlighter-rouge">global_test()</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">function</span> <span class="nf">global_test</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">global_test</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The first <code class="highlighter-rouge">print(c)</code> statement works, but the one at the end gives us a <code class="highlighter-rouge">nil</code> value. The <code class="highlighter-rouge">local</code> word makes it so that “c” is only visible inside of the function <code class="highlighter-rouge">global_test()</code>.</p>

<p>This is a very important concept to understand! When in doubt, make your variable local.</p>

<p>Scope in Lua can be confusing for even experienced programmers, so don’t get discouraged if you find variables with the wrong value or you get some errors about a variable not existing. <code class="highlighter-rouge">local</code> is your friend and it will guide you through the darkness.</p>

<h2 id="conditionals---what-if">Conditionals - What if?</h2>

<p>Often when programming you need to make choices, and the <code class="highlighter-rouge">if</code> statement is what allows you to do that, so let’s just go ahead and try an <code class="highlighter-rouge">if</code> statement:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">math.random(5)</code> generates a number between one and five, then assign that value to “a”. <a href="http://lua-users.org/wiki/MathLibraryTutorial">This is another function built-in to Lua.</a></p>

<p>Now we use the <code class="highlighter-rouge">if</code> statement, and then compare “a” to 1. This is done using <code class="highlighter-rouge">==</code>. <code class="highlighter-rouge">==</code> takes the two values to the left and right of it, compares them, and returns true or false.</p>

<p>Be careful! <code class="highlighter-rouge">==</code> is for <em>comparing</em> things. <code class="highlighter-rouge">=</code> is for <em>assigning</em> things. If you use <code class="highlighter-rouge">=</code> in your if statement then you may be surprised with an error (thankfully Lua gives an error… other languages will let you assign things in an if statement, a frequent source of confusion)</p>

<p>The if statement executes the stuff inside of it if the condition is true. <code class="highlighter-rouge">==</code> isn’t the only thing you can use though, there are other comparison operators…</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This code will print “a” if it is less than 3. There’s a number of ways to compare things:</p>

<ul>
  <li>&lt; less than</li>
  <li>&gt; greater than</li>
  <li>&lt;= less than OR equal to</li>
  <li>&gt;= greater than or equal to</li>
  <li>== equal to</li>
  <li>~= not equal to</li>
</ul>

<p>Sometimes your code will need to test two different things before it does something, so LUA has the operators <code class="highlighter-rouge">and</code> and <code class="highlighter-rouge">or</code> (also <code class="highlighter-rouge">not</code> is available):</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This code will only print “a” and print “b” if “a” is greater than 3 and “b” is less than 5. (note: repl.it always gives the same random values… so your code may never work correctly depending on the output! See if you can figure out how to make this code work by utilizing scope and print statements)</p>

<p>Occasionally you will need to do one thing if a value is something, or do another thing if that the value is something else. This is where <code class="highlighter-rouge">else</code> comes in.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"less than 3"</span><span class="p">)</span>
<span class="k">else</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"greater than 3"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Other times you may need to test the value for something else. This is where you use <code class="highlighter-rouge">elseif</code>, which can be combined with <code class="highlighter-rouge">else</code> like this…:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"less than 3"</span><span class="p">)</span>
<span class="k">elseif</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"exactly 3"</span><span class="p">)</span>
<span class="k">else</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"greater than 3"</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This code should be pretty self-explanatory. Note that <code class="highlighter-rouge">elseif</code> needs a new comparison, and <code class="highlighter-rouge">else</code> does not. <code class="highlighter-rouge">else</code> happens if no other comparisons are true, so it exists on its own.</p>

<p>Try some <code class="highlighter-rouge">if</code>, <code class="highlighter-rouge">elseif</code> and <code class="highlighter-rouge">else</code> statements yourself to get a feel for it.</p>

<h2 id="loops---repeating-things">Loops - Repeating things</h2>

<p>When programming you will frequently need to do things multiple times, or process a bunch of items one after the other in the same way. Loops are how you do this.</p>

<p>Let’s try a simple loop in LUA:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">numbers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"one"</span><span class="p">,</span> <span class="s2">"two"</span><span class="p">,</span> <span class="s2">"three"</span><span class="p">,</span> <span class="s2">"four"</span><span class="p">}</span>

<span class="k">for</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="highlighter-rouge">for</code> statement declares a local variable, in this case named “index”. Then it executes the code inside the <code class="highlighter-rouge">for</code> block.</p>

<p>When it is done it goes back and increases the value of index by one, so now it’d be doing <code class="highlighter-rouge">print(numbers[2])</code>. This increases until “index” is 4, and the loop stops.</p>

<p>What if we only wanted to print every other value?</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">numbers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"one"</span><span class="p">,</span> <span class="s2">"two"</span><span class="p">,</span> <span class="s2">"three"</span><span class="p">,</span> <span class="s2">"four"</span><span class="p">}</span>

<span class="k">for</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here we have added a third number to our statement, “2”. This tells the for loop to increment index by two every time it loops.</p>

<p>Lua has another way of looping, but it will not be necessary for this tutorial. I will show you anyways, if this is confusing then you can ignore it for the context of this article.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">numbers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"one"</span><span class="p">,</span> <span class="s2">"two"</span><span class="p">,</span> <span class="s2">"three"</span><span class="p">,</span> <span class="s2">"four"</span><span class="p">}</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="#tables---storing-many-things">Tables in Lua</a> are what is called associative arrays. Each slot is two values, the key and the value.</p>

<p>So far we have been using keys that correspond to the “index”, or position in the table, and the value associated with that index.</p>

<p>When using a for loop in Lua you can extract the key and the value using the format above. Lua will go through every single key and value pair then print the key and the value. (<em>But it does not loop in order</em> if we use <code class="highlighter-rouge">pairs()</code>. That is outside the context of this tutorial! It also does not matter for us.)</p>

<p>Give it a try!</p>

<p>Perhaps this example will make it more clear…</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">numbers</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">"one"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"eins"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"two"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"zwei"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"three"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"drei"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"four"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"vier"</span><span class="p">}</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>You can ignore those square brackets in the “numbers” declaration for now, that’s just a weird thing about Lua.</p>

<p>However if you run this code you will see that the keys are a string and the values are a string. Anything can be a key and anything can be a value, and that is how you iterate over them.</p>

<h2 id="libraries---using-other-peoples-functions">Libraries - Using other people’s functions</h2>

<p>Most programmers want to write as little code as possible, and they want the code to be as correct as possible.</p>

<p>One way of achieving the first part, and <em>hopefully</em> the second part is to use somebody else’s code. people will put all their code together in a file and distribute it as what is called a “library”.</p>

<p>What we will be using is called a “module” in Lua.</p>

<p>This lets us take somebody else’s code, imported into ours, and then use the functions from the other person’s code.</p>

<p>We will be using this concept to take somebody’s GUI functions so that we can draw a GUI easily without having to write all the annoying code.</p>

<p>This is done like this for the code that we will be writing:</p>

<p><code class="highlighter-rouge">loadfile("filename.lua")()</code></p>

<p>But you don’t need to worry about that, because the GUI builder that we will be using automatically generates this code.</p>

<p>You can learn more about loading modules <a href="http://lua-users.org/wiki/ModulesTutorial">right here</a>, but the concept that we use is <a href="https://www.lua.org/pil/8.html">loading files</a>.</p>

<p>In Lua it is possible to load libraries from other people using the “module” concept, or we can take an entire file or a string that contains a Lua code and import that into our project.</p>

<p>In this tutorial we will copy and paste the code into our file.</p>

<h1 id="beginner-tutorial-part-2---programming-in-reaper">Beginner Tutorial Part 2 - Programming in Reaper</h1>

<p>If you are truly a beginner, I suspect you probably didn’t fully comprehend everything that I just covered, and that is totally fine.</p>

<p>It is now time to <em>actually</em> do some stuff in reaper.</p>

<h2 id="how-to-try-code">How to try code</h2>

<img src="/assets/Reaper/LuaTut/Actions.jpg" alt="Actions List">
<div class="image-caption">Actions List</div>

<p>The first thing you need to do is press <code class="highlighter-rouge">shift-/</code> or just <code class="highlighter-rouge">?</code>. This brings up the action list.</p>

<p>Click the button next to ReaScript that says new, and then save the file wherever you want.</p>

<h2 id="editing-code">Editing code</h2>

<img src="/assets/Reaper/LuaTut/Editor.jpg" alt="Editor">
<div class="image-caption">Editor</div>

<p>This is where you edit code. Let’s go ahead and try something simple:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>reaper.ShowConsoleMsg("Hello AdmiralBumblebee")
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Save the file by pressing ctrl-s on Linux and Windows, or command-s on macOS.</p>

<p>Now you are presented with a box saying hello to me.</p>

<p>If you want to get back to your code after closing that window, then go back to the actions list by pressing <code class="highlighter-rouge">?</code>, searching for the name of your script, selecting your script, then clicking edit in the lower right-hand corner.</p>

<p>If you prefer to edit your code in another program you can do that. REAPER will pick up changes as the file is saved.</p>

<h2 id="where-to-find-information">Where to find information</h2>

<p>Let’s look at that command we used again <code class="highlighter-rouge">reaper.ShowConsoleMsg()</code>. How did I figure out that this command exists?</p>

<p>In REAPER go to the help menu and select “ReaScript Documentation”.</p>

<p>This will open a window in your web browser with a bunch of documentation. <a href="https://www.extremraym.com/cloud/reascript-doc/">Alternatively you can use this nicely formatted documentation</a>.</p>

<p>When inside your browser press ctrl-f (win/lin) or cmd-f (mac) to bring up the search and enter “ShowConsoleMsg”.</p>

<p>Now you will see the documentation for `reaper.ShowConsoleMsg() with information for C, EEL,  Lua and Python.</p>

<h3 id="how-to-interpret-that-page">How to interpret that page</h3>

<p>In order to use these functions we need to understand what all this mess of text means. So let’s take the <code class="highlighter-rouge">ShowMessageBox()</code>. Open the documentation and find this function by using the search feature in your browser.</p>

<p>The Lua line looks like this <code class="highlighter-rouge">Lua: integer reaper.ShowMessageBox(string msg, string title, integer type)</code></p>

<p>So let’s break this down piece by piece:</p>

<ul>
  <li>“Lua:” - this tells us that this is the definition of the function for Lua</li>
  <li><code class="highlighter-rouge">integer</code> - as we discussed before in the <a href="#functions---doing-things">functions section</a>, functions can often return data to the thing that called to the function. The word integer tells us that the <code class="highlighter-rouge">ShowConsoleMsg()</code> function returns an integer, or a number.
    <ul>
      <li>“ret 1=OK,2=CANCEL,3=ABORT,4=RETRY,5=IGNORE,6=YES,7=NO” - if you look below at the integer type argument in the function, then you can see that there are multiple types of windows we can create with different types of buttons. <code class="highlighter-rouge">ShowMessageBox()</code> will return a numeric value that corresponds to which button the user pressed. Based on that information we can proceed in our code likely by using a <a href="#conditionals---what-if">conditional</a></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">reaper.ShowMessageBox(</code> -  all functions for Lua are preceded by the word reaper, followed by the name of the function.  I’ve seen this as a common mistake for beginners where they forget to put the word reaper in front of functions provided by reaper.</li>
  <li><code class="highlighter-rouge">string msg, string title, integer type)</code> -  once again as discussed in the <a href="#functions---doing-things">functions section</a>, function sometimes need to take data from outside. this function takes a string, another string and an integer. we do not need to provide all of these, as you can see above that we only provide a string initially.
    <ul>
      <li><code class="highlighter-rouge">string msg</code> - this is the message that is shown</li>
      <li><code class="highlighter-rouge">string title</code> - this will change the title of the window that is showing the message</li>
      <li><code class="highlighter-rouge">integer type</code> - in the documentation we see “type 0=OK,1=OKCANCEL,2=ABORTRETRYIGNORE,3=YESNOCANCEL,4=YESNO,5=RETRYCANCEL”,  so if for instance we provided the number 2, then we would get a window with aboart, retry and ignore buttons.</li>
    </ul>
  </li>
</ul>

<p>This may seem like a lot of information to process at first, but as you are looking for functions that do what you need it will become more obvious what the return values and arguments need to be.</p>

<p>If all else fails, then you just need to experiment…  the documentation is not that great.</p>

<h1 id="beginner-tutorial-part-3---writing-the-script">Beginner Tutorial Part 3 - Writing the script</h1>

<p>Alright it’s time to write the script. Let’s just dig right in.</p>

<h2 id="get-information">Get information</h2>

<p>The first thing our script needs to do is get some information, it needs to know the track and the envelope that we wish to affect.</p>

<p>So what were going to start with is to get the select the track and the selected envelope.</p>

<p>Open up your REAPER documentation and search for “getselected”. You’ll see some options and look until you find these:</p>

<p><code class="highlighter-rouge">Lua: MediaTrack reaper.GetSelectedTrack(ReaProject proj, integer seltrackidx)</code></p>

<p><code class="highlighter-rouge">Lua: TrackEnvelope reaper.GetSelectedEnvelope(ReaProject proj)</code></p>

<p>We are always going to pass a value of 0 for <code class="highlighter-rouge">ReaProject proj</code>. That means that we wish to affect the current project and not something in the background.</p>

<p><code class="highlighter-rouge">reaper.GetSelectedTrack(ReaProject proj, integer seltrackidx)</code> has a value named “seltrackidx”. Since you can select multiple tracks in reaper, ReaScript needs to know which of the selected tracks you wish to grab, and we will always grab the first selected track, which has an index value of 0.</p>

<p>So in our code will look like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now the value “sel_track” contains data of the type <code class="highlighter-rouge">MediaTrack</code>. So when we want to use another function that is expecting <code class="highlighter-rouge">MediaTrack</code> we can pass “sel_track” to it.</p>

<p>The same goes for “sel_env”, which now has a <code class="highlighter-rouge">TrackEnvelope</code> stored inside of it.</p>

<h2 id="safety">Safety</h2>

<p>Before we do anything with “sel_track” or “sel_env” we need to make sure that it exists. If we try to use a value that does not exist then we will get an error. So let’s make sure were careful about this</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>

<span class="k">if</span> <span class="n">sel_track</span> <span class="k">then</span>
    <span class="c1">-- do things to the track</span>
<span class="k">else</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">if</span> <span class="n">sel_env</span> <span class="k">then</span>
    <span class="c1">-- do things to the envelope.</span>
<span class="k">else</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Go ahead and test this code.</p>

<p>Since we can identify two different things that we are doing separately, let’s put these things into functions so that we can reuse them easily.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We put all of the code for getting a track and getting an envelope into their own functions. If we need to get the track or get the function multiple times when we do not need to rewrite this code we just call the function.</p>

<p>Note that the values of “sel_track” and “sel_env” are not local. That means that other functions in the program can see these variables. This will be important later.</p>

<p>This is generally not good programming practice, but for the simplicity of this tutorial and how simple the script is, we will be totally fine using these global variables.</p>

<h2 id="looping-over-items">Looping over items</h2>

<p>The script that we are writing requires that the user has split the items at transients. This means the track will contain many media items that start at a transient.</p>

<p>We want to place an automation item on the selected envelope that corresponds to the start of every media on the selected track.</p>

<p>In order to do this we need to be able to get a table of all the media items, and then loop over all of those items.</p>

<p>Let’s add a new function called “main()” that uses get_track() to get all of the media items on that track.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">get_track</span><span class="p">()</span>
    <span class="n">get_envelope</span><span class="p">()</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">SetTrackSelected</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40421</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>

        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>

        <span class="kd">local</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_POSITION"</span> <span class="p">)</span>

        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowConsoleMsg</span><span class="p">(</span><span class="n">i_pos</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So here is what happens in the main function:</p>

<ul>
  <li>We want to select all of the items on the track, but what if the user has many tracks selected? We must make sure that no tracks are selected with <code class="highlighter-rouge">reaper.Main_OnCommandEx(40297, 0 , 0)</code>.
    <ul>
      <li>Then we select our desired track with <code class="highlighter-rouge">reaper.SetTrackSelected(sel_track, true)</code>.</li>
    </ul>
  </li>
  <li>We call <code class="highlighter-rouge">reaper.Main_OnCommandEx(40421, 0 , 0)</code>. This executes the action “Item: Select all items in track”. This will ensure that we have items selected if there are any.</li>
  <li>Now we get the number of items that are selected with <code class="highlighter-rouge">reaper.CountSelectedMediaItems(0)</code> then assign that to a local variable named item_count</li>
  <li>We create a for loop that goes from 0 to the size of item_count minus one. This is because in REAPER, values start at 0 (in Lua things start at 1, so we need to be explicit about what we want!).</li>
  <li>Inside of the loop we create a variable named “sel_item”. This will contain a <code class="highlighter-rouge">MediaItem</code> type value that comes from <code class="highlighter-rouge">reaper.GetSelectedMediaItem( 0, i )</code>. Look up “GetSelectedMediaItem” in the ReaScript docs to see if you can figure out why we called it with a zero and with the i. Remember that i represents the current index in the loop, so it goes from zero up to the number of items we have minus one.</li>
  <li>Now we use <code class="highlighter-rouge">GetMediaItemInfo_Value()</code> to get the current position of the item in the project and assign that to a local variable named “i_pos”</li>
  <li>Lastly we make a console message that takes “i_pos” and combines it with “\n”. “\n” indicates that we want a new line. The “..” tells Lua that we want to combine two strings. You can think of it as an addition sign when you want to add the strings together.</li>
</ul>

<p>Make sure that you understand how <code class="highlighter-rouge">GetMediaItemInfo_Value</code> works. Look at the documentation and experiment with it a little bit. You can see the values of variables on the right-hand side of the editor while the code is running, or you can use <code class="highlighter-rouge">reaper.ShowConsoleMsg()</code> to see the values of things.</p>

<p>Now we need to do something with that position, such as use that position to create new automation items on the envelope with the same position.</p>

<h2 id="create-automation-items">Create Automation Items</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">get_track</span><span class="p">()</span>
    <span class="n">get_envelope</span><span class="p">()</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">SetTrackSelected</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40421</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>

        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>

        <span class="kd">local</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_POSITION"</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
            <span class="kd">local</span> <span class="n">first_ai</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">first_ai</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_length</span> <span class="p">)</span> 
        <span class="k">end</span>    
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We have only added a few lines here.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
    <span class="kd">local</span> <span class="n">first_ai</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">first_ai</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_length</span> <span class="p">)</span> 
<span class="k">end</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So let’s look at this. This says that if we are making the first automation item, then we need to give it a pool ID of -1. This is necessary because as of this writing reaper does not let you create arbitrary pools.</p>

<p>Automation items that are in the same pool will all contain the same data and all change simultaneously when we change any single one of them.</p>

<p>Once we create this new automation item, then we need to get the pool ID from it so that all of the new automation items we create also have that pool_ID.</p>

<p>If were not processing the first automation item then we know we have a valid pool_ID and we can simply insert the automation item.</p>

<p>(Hopefully in the next version of REAPER we will not have to do this, and we can simply insert an automation item with the pool value that we want.)</p>

<p>I strongly suggest looking to the documentation and looking up:</p>

<ul>
  <li>“InsertAutomationItem”</li>
  <li>“GetSetAutomationItemInfo”</li>
</ul>

<p>Once you think you have a basic idea of how these work and let’s move onto the next section.</p>

<h2 id="setting-a-length">Setting a length</h2>

<p>In our code so far we simply set an automation length of one. I would like to use the length of the smallest item, and later we will allow the user to input a length.</p>

<p>So let’s find the item when the shortest length</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">get_length</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">min_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>
        <span class="kd">local</span> <span class="n">i_len</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_LENGTH"</span> <span class="p">)</span>
    
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
            <span class="n">min_len</span> <span class="o">=</span> <span class="n">i_len</span>
        <span class="k">else</span>
            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">math.min</span><span class="p">(</span><span class="n">i_len</span><span class="p">,</span> <span class="n">min_len</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">min_len</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This function makes the scary assumption that we have selected items, which we may not have. I’m going to leave it up to you to fix that.</p>

<p>After that assumption we go through all of the selected items as we have before. We store the current selected item in the loop in “sel_item”, then we use “sel_item” to get the length of the item.</p>

<p>If this is our first time through the loop then we assign “min_len” to the length of that item. (<code class="highlighter-rouge">if i == 0 then</code>…)</p>

<p>For each subsequent item that we evaluate, we assign “min_len” to either “i_len” or “min_len”. Math.min() takes two values and returns the lesser of the two.</p>

<p>As we loop through the items eventually “min_len” will be the value of the smallest item.</p>

<p>Then we return that so that we can use that value in the place that we call the function.</p>

<p><strong>I strongly suggest</strong> taking a minute to use <code class="highlighter-rouge">reaper.ShowConsoleMsg()</code> to show yourself what is happening in this function. Print out the current “i” value, the current “i_len”, the current “min_len” and perhaps the name of the media item that you are processing. You remember how to do that?</p>

<p>Use things like “..” to put strings together and “\n” to create a new line.</p>

<p>Do this any time you become confused! I actually had an issue while writing this code were I accidentally typed “min_length” instead of “min_len”. I ended up getting this cryptic error that I could not figure out until I started putting little messages to give me idea of what values were at what point.</p>

<p>This tends to be called “printf debugging” (due to how print is done in C). Some other languages have fancy debuggers, but with any language this is a powerful and quick way to figure out what is happening in your code. Don’t be afraid of it.</p>

<h2 id="put-it-all-together">Put it all together</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">get_track</span><span class="p">()</span> <span class="c1">-- call the get_track function to update sel_track with a value</span>
    <span class="n">get_envelope</span><span class="p">()</span> <span class="c1">-- call the get_env function to update sel_track with a value</span>

    <span class="c1">-- if there is no selected track or envelope, then jump to ::continue:: and ignore everything in between</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
   
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- deselect all tracks</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">SetTrackSelected</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">-- set one selected track, the first one</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40421</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- select all media items on the track</span>
    
    <span class="c1">-- count the number of selected media items</span>
    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="c1">-- find out the length of the smallest Media Item, that is our Automation Item length</span>
    <span class="kd">local</span> <span class="n">ai_len</span> <span class="o">=</span> <span class="n">get_length</span><span class="p">()</span>

    <span class="c1">-- loo from 0 to the number of media items, minus one.</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span> 

        <span class="c1">-- get the media item in the selection that corresponds to the current index (i in our loop keeps </span>
        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>

        <span class="c1">-- get the position of the media item.</span>
        <span class="kd">local</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_POSITION"</span> <span class="p">)</span> 

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> 
            <span class="c1">-- First Automation item currently must be created with a pool_id of -1</span>
            <span class="kd">local</span> <span class="n">first_ai</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span>
            <span class="c1">-- find out what the POOL_ID we need to use is, based on the AutomationItem we just created</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">first_ai</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="c1">-- insert a new automation item on the selected envelope, with the ID we got, </span>
            <span class="c1">-- at the posistion of the current item in the loop with the length of the smallest Media Item</span>
            <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span> 
        <span class="k">end</span>    
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="c1">-- get the selected track. sel_track is a global variable that can be seen by every function!</span>
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">-- if there is no selected track, then we complain to the user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="c1">-- get the selected envelope. sel_env is a global variable that can be seen by every function!</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="c1">-- if there is no selected envelope, then we complain to the use</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It looks like we actually have all of our working code down. this will take the selected track, the selected envelope and make a new automation item at the start of every media item, and the length of the automation item equals the length of the smallest media item.</p>

<p>This time I have added some comments to the code to help make it be more clear for first-time readers.</p>

<p>We did add one small thing here,</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If there is no “sel_track” or “sel_env” then we wanna abort our mission immediately. We <code class="highlighter-rouge">return</code> from our function immediately, and no further code will be processed.</p>

<p>Ideally we’d encapsulate this all in a class (using metatables) and pass values (and a few closures) around via functions while relying on no globals, but that would add complexity for zero benefit in this simple case. I also don’t want to make this tutorial too long :)</p>

<p>As your scripts become complex, you’ll google for solutions and find out about better practices, new functionality and see some fun arguments about how things should be done.</p>

<h1 id="beginner-tutorial-part-3---making-a-gui">Beginner Tutorial Part 3 - Making a GUI</h1>

<p>Our code works if you run it and you have a track and an envelope selected. However, there is no way for the user to set the length of time that they want that automation items to be.</p>

<p>So let’s create a GUI that allows the user to select a track, select an envelope, set the length of the automation item and then do the process when they are ready.</p>

<h2 id="gui-builder">GUI Builder</h2>

<img src="/assets/Reaper/LuaTut/GUIBuilder.jpg" alt="Lokasenna's GUI Builder">
<div class="image-caption">Lokasenna's GUI Builder</div>

<p>The first thing you need to do is to go to ReaPack-&gt;Browse Packages. Install the following packages:</p>

<ul>
  <li>Lokasenna’s GUI library v2 for Lua</li>
  <li>Lokasenna’s GUI library v2 for Lua (developer tools)</li>
</ul>

<p>Now go to the actions list using <code class="highlighter-rouge">?</code> (<code class="highlighter-rouge">shift-/</code>). Select “Script: Set Lokasenna_GUI v2 library path.lua” and hit run.</p>

<p>Now select “Script: Lokasenna_GUI Builder.lua”. Hit Run.</p>

<p>Right click in the middle of the window that pops up, this is where you can add new GUI elements to the screen.</p>

<p>To move a GUI widget or select a GUI widget for editing you need to hold shift and click it.</p>

<h2 id="build-the-gui">Build the GUI</h2>

<img src="/assets/Reaper/LuaTut/MainGUI.jpg" alt="My GUI Attempt">
<div class="image-caption">My GUI Attempt</div>

<p>Build something like the GUI that you see above.</p>

<p>You will at least need these elements:</p>

<ul>
  <li>A textbox to show the current selected Track</li>
  <li>A textbox to show the current selected Envelope</li>
  <li>A textbox to get the length of the AI</li>
  <li>A button to get the currently selected Track</li>
  <li>A button to get the currently selected Envelope</li>
  <li>A button to clear the currently selected Track</li>
  <li>A button to clear the currently selected Envelope</li>
  <li>A button to DO IT!</li>
</ul>

<p>When you’re done with your GUI go to the menu item “File-&gt;Export” and export the file to a location you are familiar with.</p>

<p><strong>It really is that easy!</strong></p>

<p>Just play around with it and make a few rubbish attempts. It works quite nicely.</p>

<h2 id="use-the-gui">Use the GUI</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre></td><td class="rouge-code"><pre><span class="c1">-- Script generated by Lokasenna's GUI Builder</span>


<span class="kd">local</span> <span class="n">lib_path</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetExtState</span><span class="p">(</span><span class="s2">"Lokasenna_GUI"</span><span class="p">,</span> <span class="s2">"lib_path_v2"</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">lib_path</span> <span class="ow">or</span> <span class="n">lib_path</span> <span class="o">==</span> <span class="s2">""</span> <span class="k">then</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">MB</span><span class="p">(</span><span class="s2">"Couldn't load the Lokasenna_GUI library. Please run 'Set Lokasenna_GUI v2 library path.lua' in the Lokasenna_GUI folder."</span><span class="p">,</span> <span class="s2">"Whoops!"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">end</span>
<span class="nb">loadfile</span><span class="p">(</span><span class="n">lib_path</span> <span class="o">..</span> <span class="s2">"Core.lua"</span><span class="p">)()</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Label.lua"</span><span class="p">)()</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Button.lua"</span><span class="p">)()</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Textbox.lua"</span><span class="p">)()</span>
<span class="c1">-- If any of the requested libraries weren't found, abort the script.</span>
<span class="k">if</span> <span class="n">missing_lib</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Items to Pooled AI"</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">605</span><span class="p">,</span> <span class="mi">130</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">anchor</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">corner</span> <span class="o">=</span> <span class="s2">"mouse"</span><span class="p">,</span> <span class="s2">"C"</span>


<span class="cm">--[[
    *********************
    * Insert Code here! *
    *********************    
]]</span><span class="c1">--</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"get_env_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Get Envelope"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span>
<span class="p">})</span>


<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"get_track_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">395</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Get Track"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"clear_env_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">230</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Clear"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"clear_track_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">515</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Clear"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"do_it_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">495</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Do It!"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"cur_env_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Current Envelope"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"cur_track_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">395</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Current Track"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"len_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Length of AI"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is basically what is output from the GUI editor.</p>

<p>So what we need to do is insert our code into this file, and then connect the buttons to functions.</p>

<p>So where I have the comment that says “Insert code here”, place your current code in that location. We could keep our GUI code in a separate file and use a function called “loadfile” which lets you load a file into your current code. You can try doing this yourself, but for this tutorial we will just insert our current code into the generated GUI.</p>

<h2 id="make-the-buttons-work">Make the buttons work</h2>

<p>The next thing we need to do is add some code to the buttons so that they do something when you press it. Let’s look at what we need to do to the envelope button.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"get_env_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Get Envelope"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">get_envelope</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I have done two things here:</p>

<ul>
  <li>Add a comma after <code class="highlighter-rouge">col_fill = "elm_frame"</code>. Every item, except the last item, needs a comma at the end. Since we’re adding a new item to the end, this is no longer the last item and it will need a comma</li>
  <li>Add <code class="highlighter-rouge">func = get_envelope</code> as the last item. This tells the button that when it is pressed, we want it to run the <code class="highlighter-rouge">get_envelope()</code> function. <strong>CAREFUL</strong>. You want <code class="highlighter-rouge">func = get_envelope</code> and <em>NOT</em> <code class="highlighter-rouge">func = get_envelope()</code>. The latter will call the function immediately. We only want to pass the <em>name</em> of the function, so we leave out the parenthesis.</li>
</ul>

<p>So go ahead and connect the buttons to your main function, to the get_track function, and you will need to create two “clear” functions. The information you need to create the “clear_envelope” and “clear_track” functions are in the next section.</p>

<p>At this point you can load the script, run it, and you’ll get a nice GUI… that doesn’t work at all.</p>

<h2 id="interact-with-the-gui---get_track">Interact with the GUI - get_track</h2>

<p>When the user presses the “Get track”, or “Get envelope” then we want the GUI to display the name of the track or envelope in the text box that we created.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="c1">-- get the selected track. sel_track is a global variable that can be seen by every function!</span>
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">-- if there is no selected track, then we complain to the user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c1">-- get track name</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="s2">"P_NAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="c1">-- set GUI text box to track name</span>
        <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"cur_track_txt"</span><span class="p">,</span> <span class="n">track_name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here we’ve added an ‘else’ section to our code. If the sel_track exists then we want to change the GUI.</p>

<p>There is a trick here though. Look at this line:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="s2">"P_NAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>What is that <code class="highlighter-rouge">_</code>?</p>

<p>The function <code class="highlighter-rouge">GetSetMediaTrackInfo_String()</code> returns two values. The declaration is:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">boolean</span> <span class="n">retval</span><span class="p">,</span> <span class="n">string</span> <span class="n">stringNeedBig</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">MediaTrack</span> <span class="n">tr</span><span class="p">,</span> <span class="n">string</span> <span class="n">parmname</span><span class="p">,</span> <span class="n">string</span> <span class="n">stringNeedBig</span><span class="p">,</span> <span class="n">boolean</span> <span class="n">setNewValue</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We only need the track name, but it returns <code class="highlighter-rouge">boolean retval, string stringNeedBig</code>. We need to deal with both values though! That’s what <code class="highlighter-rouge">_</code> lets us do.</p>

<p><code class="highlighter-rouge">local _, track_name</code> says “Forget the first return value, assign the second value to <code class="highlighter-rouge">track_name</code>”.</p>

<p>This is a <em>powerful</em> feature of Lua, and it can be slightly confusing sometimes. Just know that if a function has multiple return values, then you need to somehow assign all of them to a variable. If you want to ignore one, then use <code class="highlighter-rouge">_</code> in that place.</p>

<p>The return values are processed in order. So if we had a function like <code class="highlighter-rouge">reaper.GetTempoTimeSigMarker()</code> that is declared as:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">boolean</span> <span class="n">retval</span><span class="p">,</span> <span class="n">number</span> <span class="n">timepos</span><span class="p">,</span> <span class="n">number</span> <span class="n">measurepos</span><span class="p">,</span> <span class="n">number</span> <span class="n">beatpos</span><span class="p">,</span> <span class="n">number</span> <span class="n">bpm</span><span class="p">,</span> <span class="n">number</span> <span class="n">timesig_num</span><span class="p">,</span> <span class="n">number</span> <span class="n">timesig_denom</span><span class="p">,</span> <span class="n">boolean</span> <span class="n">lineartempo</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetTempoTimeSigMarker</span><span class="p">(</span><span class="n">ReaProject</span> <span class="n">proj</span><span class="p">,</span> <span class="n">integer</span> <span class="n">ptidx</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If we want to use any of those values, we need to process all of them. Something like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">time_pos</span><span class="p">,</span> <span class="n">measure_pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sig_numerator</span><span class="p">,</span> <span class="n">sig_denominator</span><span class="p">,</span> <span class="n">linear_bool</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetTempoTimeSigMarker</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This calls “GetTempoTimeSigMarker” and assigns</p>

<ul>
  <li>retval will not be assigned</li>
  <li>time_pos = timepos</li>
  <li>measure_pos = measurepos</li>
  <li>beatpos will not be assigned</li>
  <li>bpm will not be assigned</li>
  <li>sig_numerator = timesig_num</li>
  <li>sig_denominator = timesig_denom</li>
  <li>linear_bool = lineartempo</li>
</ul>

<p>We can now use the variables <code class="highlighter-rouge">time_pos</code>, <code class="highlighter-rouge">measure_pos</code>, <code class="highlighter-rouge">sig_numerator</code>, <code class="highlighter-rouge">sig_denominator</code>, <code class="highlighter-rouge">linear_bool</code>, in our code. They were all simultaneously assigned by the return function.</p>

<p>Lua lets us return many values from a function, and we can assign these multiple return values at once. We can also ignore return values by using <code class="highlighter-rouge">_</code></p>

<h2 id="interact-with-the-gui---get_envelope">Interact with the GUI - get_envelope</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="c1">-- get the selected envelope. sel_env is a global variable that can be seen by every function!</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="c1">-- if there is no selected envelope, then we complain to the use</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c1">-- get the name of the selected envelope</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">env_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetEnvelopeName</span><span class="p">(</span><span class="n">sel_env</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="c1">-- get the track that the envelope is attached to</span>
        <span class="kd">local</span> <span class="n">parent_track</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">Envelope_GetParentTrack</span><span class="p">(</span><span class="n">sel_env</span><span class="p">)</span>
        <span class="c1">-- get the name of the track</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">parent_track</span><span class="p">,</span> <span class="s2">"P_NAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"cur_env_txt"</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">..</span> <span class="s2">" - "</span> <span class="o">..</span> <span class="n">env_name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I want to do more than just list the envelope name in the text box. I want to do something like “track_name - envelope_name”. So first we need to get the name of the envelope.</p>

<p><code class="highlighter-rouge">local _, env_name = reaper.GetEnvelopeName(sel_env, "")</code> uses the <code class="highlighter-rouge">_</code> trick. Look up “GetEnvelopeName” to see why we needed to do that.</p>

<p>Once we have the envelope name, we want the name of the track that the envelope is attached to. “GetSetMediaTrackInfo_String”s first argument is <code class="highlighter-rouge">MediaTrack tr</code>. That means we need a variable with a <a href="#types---what-things-are">type</a> of “MediaTrack”.</p>

<p>So I searched <a href="#where-to-find-information">through the documentation</a> until I found something that uses the envelope and returns a “MediaTrack”. <code class="highlighter-rouge">Envelope_GetParentTrack()</code> does this!</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">MediaTrack</span> <span class="n">retval</span><span class="p">,</span> <span class="n">optional</span> <span class="n">number</span> <span class="n">index</span><span class="p">,</span> <span class="n">optional</span> <span class="n">number</span> <span class="n">index2</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">Envelope_GetParentTrack</span><span class="p">(</span><span class="n">TrackEnvelope</span> <span class="n">env</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We really only need the <code class="highlighter-rouge">MediaTrack retval</code>, so we use our <code class="highlighter-rouge">_</code> trick to get that and ignore everything else.</p>

<p>Now that we have the name of the track and the name of the envelope, we can set the text box to <code class="highlighter-rouge">track_name .. " - " .. env_name</code>. Remember that <code class="highlighter-rouge">..</code> just puts two strings together. We combine the track name with “ - “ and then the envelope name.</p>

<h2 id="clear-the-selected-track-and-envelope">Clear the selected track and envelope</h2>

<p>I’m not going to tell you how to do this! The code I publish at the end will not have this either.</p>

<p>You need to set <code class="highlighter-rouge">sel_track</code> and <code class="highlighter-rouge">sel_envelope</code> to <code class="highlighter-rouge">nil</code> and clear the GUI textboxes.</p>

<p>Remember to attach your <code class="highlighter-rouge">clear_track()</code> and <code class="highlighter-rouge">clear_envelope()</code> functions to the buttons too.</p>

<h2 id="get-the-length">Get the length</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">get_length</span><span class="p">()</span>
    <span class="c1">-- get the value from the GUI</span>
    <span class="n">gui_len</span> <span class="o">=</span> <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"len_txt"</span><span class="p">)</span>

    <span class="c1">-- If there's no value then we use the length of the shortest item</span>
    <span class="k">if</span> <span class="n">gui_len</span> <span class="o">==</span> <span class="s2">""</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>
            <span class="kd">local</span> <span class="n">i_len</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_LENGTH"</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
                <span class="n">min_len</span> <span class="o">=</span> <span class="n">i_len</span>
            <span class="k">else</span>
                <span class="n">min_len</span> <span class="o">=</span> <span class="nb">math.min</span><span class="p">(</span><span class="n">i_len</span><span class="p">,</span> <span class="n">min_len</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="k">return</span> <span class="n">min_len</span>
    <span class="k">else</span>
        <span class="c1">-- if there is a value, we convert the string to a number and use it!</span>
        <span class="k">return</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">gui_len</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Part of setting up the GUI was that we wanted the user to be able to set the length of the automation items that are created.</p>

<p>We already have the code for finding the minimum length. All we need to do is get the value from the GUI. If the GUI does not have a value then we use the minimum length code we used.</p>

<p>Otherwise (else) we convert the “gui_len” to a number and return it to whereever the function was called.</p>

<h2 id="update-main">Update Main</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="c1">-- if there is no selected track or envelope, then jump to ::continue:: and ignore everything in between</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Undo_BeginBlock</span><span class="p">()</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- deselect all tracks</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">SetTrackSelected</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40421</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- select all media items on the track</span>
    
    <span class="c1">-- count the number of selected media items</span>
    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="c1">-- find out the length of the smallest Media Item, that is our Automation Item length</span>
    <span class="kd">local</span> <span class="n">ai_len</span> <span class="o">=</span> <span class="n">get_length</span><span class="p">()</span>

    <span class="c1">-- loo from 0 to the number of media items, minus one.</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span> 

        <span class="c1">-- get the media item in the selection that corresponds to the current index (i in our loop keeps </span>
        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>

        <span class="c1">-- get the position of the media item.</span>
        <span class="kd">local</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_POSITION"</span> <span class="p">)</span> 

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> 
            <span class="c1">-- First Automation item currently must be created with a pool_id of -1</span>
            <span class="kd">local</span> <span class="n">first_ai</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span>
            <span class="c1">-- find out what the POOL_ID we need to use is, based on the AutomationItem we just created</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">first_ai</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="c1">-- insert a new automation item on the selected envelope, with the ID we got, </span>
            <span class="c1">-- at the posistion of the current item in the loop with the length of the smallest Media Item</span>
            <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span> 
        <span class="k">end</span>    
    <span class="k">end</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Undo_EndBlock</span><span class="p">(</span> <span class="s2">"Items to Pooled AI"</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since we have buttons that do <code class="highlighter-rouge">get_track()</code> and <code class="highlighter-rouge">get_envelope()</code> for us, we don’t need these in the “main()” block anymore.</p>

<p>When we use this, we will want the user to be able to undo the action. So before we do anything, we put <code class="highlighter-rouge">reaper.Undo_BeginBlock()</code> in. This tells REAPER that anything we do is going to be consolidated into a single undo stage.</p>

<p>After we do all of our work we put the code <code class="highlighter-rouge">reaper.Undo_EndBlock( "Items to Pooled AI", 0 )</code>. the first argument to <code class="highlighter-rouge">Undo_EndBlock()</code> will be what the undo shows up in REAPER’s undo history. (What’s the second argument? Find it, and figure it out, yourself!)</p>

<h2 id="end">End</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
</pre></td><td class="rouge-code"><pre><span class="c1">-- Script generated by Lokasenna's GUI Builder</span>

<span class="kd">local</span> <span class="n">lib_path</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetExtState</span><span class="p">(</span><span class="s2">"Lokasenna_GUI"</span><span class="p">,</span> <span class="s2">"lib_path_v2"</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">lib_path</span> <span class="ow">or</span> <span class="n">lib_path</span> <span class="o">==</span> <span class="s2">""</span> <span class="k">then</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">MB</span><span class="p">(</span><span class="s2">"Couldn't load the Lokasenna_GUI library. Please run 'Set Lokasenna_GUI v2 library path.lua' in the Lokasenna_GUI folder."</span><span class="p">,</span> <span class="s2">"Whoops!"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">end</span>
<span class="nb">loadfile</span><span class="p">(</span><span class="n">lib_path</span> <span class="o">..</span> <span class="s2">"Core.lua"</span><span class="p">)()</span>


<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Label.lua"</span><span class="p">)()</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Button.lua"</span><span class="p">)()</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">req</span><span class="p">(</span><span class="s2">"Classes/Class - Textbox.lua"</span><span class="p">)()</span>
<span class="c1">-- If any of the requested libraries weren't found, abort the script.</span>
<span class="k">if</span> <span class="n">missing_lib</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Items to Pooled AI"</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">605</span><span class="p">,</span> <span class="mi">130</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">anchor</span><span class="p">,</span> <span class="n">GUI</span><span class="p">.</span><span class="n">corner</span> <span class="o">=</span> <span class="s2">"mouse"</span><span class="p">,</span> <span class="s2">"C"</span>


<span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="c1">-- if there is no selected track or envelope, then jump to ::continue:: and ignore everything in between</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Undo_BeginBlock</span><span class="p">()</span>

    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40297</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- deselect all tracks</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">SetTrackSelected</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">-- make sure our track is selected</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Main_OnCommandEx</span><span class="p">(</span><span class="mi">40421</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- select all media items on the track</span>
    
    <span class="c1">-- count the number of selected media items</span>
    <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="c1">-- find out the length of the smallest Media Item, that is our Automation Item length</span>
    <span class="kd">local</span> <span class="n">ai_len</span> <span class="o">=</span> <span class="n">get_length</span><span class="p">()</span>

    <span class="c1">-- loo from 0 to the number of media items, minus one.</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span> 

        <span class="c1">-- get the media item in the selection that corresponds to the current index (i in our loop keeps </span>
        <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>

        <span class="c1">-- get the position of the media item.</span>
        <span class="kd">local</span> <span class="n">i_pos</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_POSITION"</span> <span class="p">)</span> 

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> 
            <span class="c1">-- First Automation item currently must be created with a pool_id of -1</span>
            <span class="kd">local</span> <span class="n">first_ai</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span>
            <span class="c1">-- find out what the POOL_ID we need to use is, based on the AutomationItem we just created</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">first_ai</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="c1">-- insert a new automation item on the selected envelope, with the ID we got, </span>
            <span class="c1">-- at the posistion of the current item in the loop with the length of the smallest Media Item</span>
            <span class="n">reaper</span><span class="p">.</span><span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">sel_env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">ai_len</span> <span class="p">)</span> 
        <span class="k">end</span>    
    <span class="k">end</span>
    <span class="n">reaper</span><span class="p">.</span><span class="n">Undo_EndBlock</span><span class="p">(</span> <span class="s2">"Items to Pooled AI"</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_track</span><span class="p">()</span> 
    <span class="c1">-- get the selected track. sel_track is a global variable that can be seen by every function!</span>
    <span class="n">sel_track</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedTrack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">-- if there is no selected track, then we complain to the user</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_track</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select a track!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c1">-- get track name</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">sel_track</span><span class="p">,</span> <span class="s2">"P_NAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="c1">-- Set GUI text box to track_name</span>
        <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"cur_track_txt"</span><span class="p">,</span> <span class="n">track_name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">get_envelope</span><span class="p">()</span>
    <span class="c1">-- get the selected envelope. sel_env is a global variable that can be seen by every function!</span>
    <span class="n">sel_env</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="c1">-- if there is no selected envelope, then we complain to the use</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sel_env</span> <span class="k">then</span>
        <span class="n">reaper</span><span class="p">.</span><span class="n">ShowMessageBox</span><span class="p">(</span><span class="s2">"Please select an envelope!"</span><span class="p">,</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c1">-- get the name of the selected envelope</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">env_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetEnvelopeName</span><span class="p">(</span><span class="n">sel_env</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="c1">-- get the track that the envelope is attached to</span>
        <span class="kd">local</span> <span class="n">parent_track</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">Envelope_GetParentTrack</span><span class="p">(</span><span class="n">sel_env</span><span class="p">)</span>
        <span class="c1">-- get the name of the track</span>
        <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSetMediaTrackInfo_String</span><span class="p">(</span><span class="n">parent_track</span><span class="p">,</span> <span class="s2">"P_NAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="c1">-- Set GUI text box to track_name + envelope name</span>
        <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"cur_env_txt"</span><span class="p">,</span> <span class="n">track_name</span> <span class="o">..</span> <span class="s2">" - "</span> <span class="o">..</span> <span class="n">env_name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>


<span class="k">function</span> <span class="nf">get_length</span><span class="p">()</span>
    <span class="c1">-- get the value from the GUI</span>
    <span class="n">gui_len</span> <span class="o">=</span> <span class="n">GUI</span><span class="p">.</span><span class="n">Val</span><span class="p">(</span><span class="s2">"len_txt"</span><span class="p">)</span>

    <span class="c1">-- If there's no value then we use the length of the shortest item</span>
    <span class="k">if</span> <span class="n">gui_len</span> <span class="o">==</span> <span class="s2">""</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">item_count</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">CountSelectedMediaItems</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">sel_item</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetSelectedMediaItem</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span>
            <span class="kd">local</span> <span class="n">i_len</span> <span class="o">=</span> <span class="n">reaper</span><span class="p">.</span><span class="n">GetMediaItemInfo_Value</span><span class="p">(</span> <span class="n">sel_item</span><span class="p">,</span> <span class="s2">"D_LENGTH"</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
                <span class="n">min_len</span> <span class="o">=</span> <span class="n">i_len</span>
            <span class="k">else</span>
                <span class="n">min_len</span> <span class="o">=</span> <span class="nb">math.min</span><span class="p">(</span><span class="n">i_len</span><span class="p">,</span> <span class="n">min_len</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="k">return</span> <span class="n">min_len</span>
    <span class="k">else</span>
        <span class="c1">-- if there is a value, we convert the string to a number and use it!</span>
        <span class="k">return</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">gui_len</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">clear_envelope</span> <span class="p">()</span>


<span class="k">end</span>

<span class="c1">-- main()</span>


<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"get_env_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Get Envelope"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">get_envelope</span>
<span class="p">})</span>


<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"get_track_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">395</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Get Track"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">get_track</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"clear_env_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">230</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Clear"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">clear_envelope</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"clear_track_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">515</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Clear"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">clear_track</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"do_it_btn"</span><span class="p">,</span> <span class="s2">"Button"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">495</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Do It!"</span><span class="p">,</span>
    <span class="n">font</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">col_txt</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">col_fill</span> <span class="o">=</span> <span class="s2">"elm_frame"</span><span class="p">,</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">DoIt</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"cur_env_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Current Envelope"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"cur_track_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">395</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Current Track"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s2">"len_txt"</span><span class="p">,</span> <span class="s2">"Textbox"</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">"Length of AI"</span><span class="p">,</span>
    <span class="n">cap_pos</span> <span class="o">=</span> <span class="s2">"left"</span><span class="p">,</span>
    <span class="n">font_a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">font_b</span> <span class="o">=</span> <span class="s2">"monospace"</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s2">"txt"</span><span class="p">,</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">"wnd_bg"</span><span class="p">,</span>
    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">undo_limit</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">})</span>

<span class="n">GUI</span><span class="p">.</span><span class="n">Init</span><span class="p">()</span>
<span class="n">GUI</span><span class="p">.</span><span class="n">Main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>That’s everything!</p>

<p>That code works, and there’s still some that you need to fill in yourself <a href="#clear-the-selected-track-and-envelope">as I described earlier</a>.</p>

<p>I have also included (at least) 2 code paths that could lead to a crash. See if you can figure out where a user may do something that could crash the script. Read through the code and think to yourself “Does this variable always exist?” I tried to make this fairly easy to find for an intermediate developer. Beginners may need some time to find it.</p>

<p>You also need to think about what happens if a user already has some media items selected. That will mess everything up! Fix that.</p>

<h1 id="mpls-awesome-code">MPL’s awesome code</h1>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">reaper</span><span class="p">)</span> <span class="k">do</span> <span class="nb">_G</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">reaper</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="k">end</span> 
  <span class="c1">----------------------------------------------------------------------------  </span>
  <span class="k">function</span> <span class="nf">BuildPointsFromTable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
    <span class="kd">local</span> <span class="n">env</span> <span class="o">=</span>  <span class="n">GetSelectedEnvelope</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
    <span class="n">DeleteEnvelopePointRangeEx</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span> <span class="p">)</span>
    
    <span class="c1">-- clear AI</span>
    <span class="kd">local</span> <span class="n">clear_id</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">autoitem_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CountAutomationItems</span><span class="p">(</span> <span class="n">env</span> <span class="p">)</span> <span class="k">do</span>
      <span class="kd">local</span> <span class="n">AI_pos</span> <span class="o">=</span> <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">autoitem_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'D_POSITION'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span>
      <span class="kd">local</span> <span class="n">AI_len</span> <span class="o">=</span> <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">autoitem_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'D_LENGTH'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span>
      <span class="k">if</span>    <span class="p">(</span><span class="n">AI_pos</span> <span class="o">&gt;=</span> <span class="n">time_start</span> <span class="ow">and</span> <span class="n">AI_pos</span> <span class="o">&lt;=</span> <span class="n">time_end</span><span class="p">)</span>
        <span class="ow">or</span>  <span class="p">(</span><span class="n">AI_pos</span> <span class="o">+</span> <span class="n">AI_len</span> <span class="o">&gt;=</span> <span class="n">time_start</span> <span class="ow">and</span> <span class="n">AI_pos</span> <span class="o">+</span> <span class="n">AI_len</span> <span class="o">&lt;=</span> <span class="n">time_end</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">AI_pos</span> <span class="o">&lt;</span> <span class="n">time_start</span> <span class="ow">and</span> <span class="n">AI_pos</span> <span class="o">+</span> <span class="n">AI_len</span> <span class="o">&gt;</span> <span class="n">time_end</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">clear_id</span><span class="p">[</span><span class="o">#</span><span class="n">clear_id</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoitem_idx</span>          
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">#</span><span class="n">clear_id</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span> <span class="n">DeleteEnvelopePointRangeEx</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">clear_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">end</span>
    
    <span class="c1">-- get max len</span>
    <span class="kd">local</span> <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">max_len</span> <span class="o">=</span> <span class="nb">math.max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">pos</span> <span class="o">-</span>  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c1">-- insert AI</span>
    <span class="kd">local</span> <span class="n">pool_id</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">#</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span> 
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">#</span><span class="n">t</span> <span class="k">then</span>
          <span class="kd">local</span> <span class="n">new_AI</span> <span class="o">=</span> <span class="n">InsertAutomationItem</span><span class="p">(</span><span class="n">env</span> <span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_len</span> <span class="p">)</span> 
          <span class="n">pool_id</span> <span class="o">=</span> <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">new_AI</span><span class="p">,</span> <span class="s2">"D_POOL_ID"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
          <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">new_AI</span><span class="p">,</span> <span class="s1">'D_LOOPSRC'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>
          <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">new_AI</span><span class="p">,</span> <span class="s1">'D_LENGTH'</span><span class="p">,</span> <span class="n">time_end</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>
          
        <span class="k">else</span>
          <span class="n">InsertAutomationItem</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">pool_id</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">,</span>  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">pos</span> <span class="o">-</span>  <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span> <span class="p">)</span>  
          <span class="n">GetSetAutomationItemInfo</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">pool_id</span><span class="p">,</span> <span class="s1">'D_LOOPSRC'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">Envelope_SortPointsEx</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
    <span class="n">UpdateArrange</span><span class="p">()</span>
  <span class="k">end</span>
  <span class="c1">----------------------------------------------------------------------------</span>
  <span class="k">function</span> <span class="nf">GetPeaks</span><span class="p">(</span><span class="n">track</span> <span class="p">,</span><span class="n">ts_st</span><span class="p">,</span> <span class="n">ts_end</span><span class="p">,</span><span class="n">window</span> <span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">accessor</span> <span class="o">=</span> <span class="n">CreateTrackAudioAccessor</span><span class="p">(</span> <span class="n">track</span> <span class="p">)</span>
    
    <span class="kd">local</span> <span class="n">proj_SR</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">format_timestr_len</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">))</span>
    <span class="kd">local</span> <span class="n">buf_sz</span><span class="o">=</span> <span class="nb">math.floor</span><span class="p">(</span><span class="n">proj_SR</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">ts_st</span><span class="p">,</span> <span class="n">ts_end</span><span class="p">,</span> <span class="n">window</span> <span class="k">do</span>      
      <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">new_array</span><span class="p">(</span><span class="n">buf_sz</span><span class="p">)</span>
      <span class="n">GetAudioAccessorSamples</span><span class="p">(</span> <span class="n">accessor</span><span class="p">,</span> <span class="n">proj_SR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">buf_sz</span><span class="p">,</span> <span class="n">buf</span> <span class="p">)</span>
      <span class="kd">local</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="kd">local</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">spl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf_sz</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="k">then</span> 
          <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="nb">math.abs</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">spl</span><span class="p">])</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">t</span><span class="p">[</span><span class="o">#</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">sum</span><span class="o">/</span><span class="n">cnt</span><span class="p">}</span>
      <span class="n">buf</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">end</span>
    <span class="n">DestroyAudioAccessor</span><span class="p">(</span> <span class="n">accessor</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>
  <span class="k">end</span>
  <span class="c1">------------------------------------------------------------------------------------------------------</span>
  <span class="k">function</span> <span class="nf">WDL_DB2VAL</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">return</span> <span class="nb">math.exp</span><span class="p">((</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mi">11512925464970228420089957273422</span><span class="p">)</span> <span class="k">end</span>  <span class="c1">--https://github.com/majek/wdl/blob/master/WDL/db2val.h</span>
  <span class="c1">----------------------------------------------------------------------------</span>
  <span class="k">function</span> <span class="nf">FilterPeaks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span><span class="n">hold_release</span><span class="p">)</span>
    
    <span class="c1">-- threshold</span>
    <span class="kd">local</span> <span class="n">idremove</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">t</span> <span class="k">do</span>  <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">then</span>  <span class="n">idremove</span><span class="p">[</span><span class="o">#</span><span class="n">idremove</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>  <span class="k">end</span> <span class="k">end</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">#</span><span class="n">idremove</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span> <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">idremove</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">end</span>
    
    <span class="c1">-- hold_release</span>
    <span class="kd">local</span> <span class="n">cur_pos</span><span class="p">,</span><span class="n">last_cur_pos</span>
    <span class="kd">local</span> <span class="n">idremove</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">t</span> <span class="k">do</span>  
      <span class="n">cur_pos</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span>
      <span class="k">if</span> <span class="n">last_cur_pos</span> <span class="ow">and</span> <span class="n">cur_pos</span> <span class="o">-</span> <span class="n">last_cur_pos</span>  <span class="o">&lt;</span> <span class="n">hold_release</span> <span class="k">then</span> <span class="n">idremove</span><span class="p">[</span><span class="o">#</span><span class="n">idremove</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="k">end</span>
      <span class="n">last_cur_pos</span> <span class="o">=</span> <span class="n">cur_pos</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">#</span><span class="n">idremove</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span> <span class="nb">table.remove</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">idremove</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1">----------------------------------------------------------------------------</span>
  <span class="k">function</span> <span class="nf">InsertTriggeredAI</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">hold_release</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">ts_st</span><span class="p">,</span> <span class="n">ts_end</span> <span class="o">=</span> <span class="n">GetSet_LoopTimeRange2</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">ts_end</span> <span class="o">-</span> <span class="n">ts_st</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
    
    <span class="kd">local</span> <span class="n">item</span> <span class="o">=</span> <span class="n">GetSelectedMediaItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
    <span class="kd">local</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">GetMediaItem_Track</span><span class="p">(</span> <span class="n">item</span> <span class="p">)</span>
    <span class="kd">local</span> <span class="n">RMS_t</span> <span class="o">=</span> <span class="n">GetPeaks</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">ts_st</span><span class="p">,</span> <span class="n">ts_end</span><span class="p">,</span> <span class="n">window</span> <span class="p">)</span>
    <span class="kd">local</span> <span class="n">threshold_linear</span> <span class="o">=</span> <span class="n">WDL_DB2VAL</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">FilterPeaks</span><span class="p">(</span><span class="n">RMS_t</span><span class="p">,</span> <span class="n">threshold_linear</span><span class="p">,</span><span class="n">hold_release</span><span class="p">)</span>
    <span class="n">BuildPointsFromTable</span><span class="p">(</span><span class="n">RMS_t</span><span class="p">,</span><span class="n">ts_st</span><span class="p">,</span> <span class="n">ts_end</span> <span class="p">)</span>
  <span class="k">end</span>
  <span class="c1">----------------------------------------------------------------------------  </span>
  

  <span class="n">ret</span><span class="p">,</span><span class="n">str</span> <span class="o">=</span> <span class="n">GetUserInputs</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'window,threshold,hold_release'</span><span class="p">,</span><span class="s1">'0.002,-20,0.05'</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ret</span> <span class="k">then</span> 
    <span class="n">ui</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">val</span> <span class="k">in</span> <span class="n">str</span><span class="p">:</span><span class="n">gmatch</span><span class="p">(</span><span class="s1">'[^,]+'</span><span class="p">)</span> <span class="k">do</span> <span class="k">if</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">then</span> <span class="n">ui</span><span class="p">[</span><span class="o">#</span><span class="n">ui</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">tonumber</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">end</span> <span class="k">end</span>
    <span class="k">if</span> <span class="o">#</span><span class="n">ui</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">then</span> <span class="n">InsertTriggeredAI</span><span class="p">(</span><span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ui</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ui</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">end</span>
  <span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="https://forum.cockos.com/showthread.php?t=188335">mpl</a> has taken the idea of this script and removed the need to pre-split the ‘triggering’ items. His script reads the audio, figures out the location of the peaks and puts automation items on the selected envelope.</p>

<p>It has some parameters to tune the peak detection.</p>

<p>Much nicer than what we’ve created and a further example of what is possible with ReaScript.</p>

<h1 id="more-resources">More Resources</h1>

<p><a href="https://www.extremraym.com/en/reascript-basics-part1/">X-Raym has a fantastic series on learning more about ReaScript</a>.</p>

<p><a href="https://adamtcroft.com/reascript-book">Adam T Croft has some excellent content about learning ReaScript</a>.</p>

<p><a href="https://forum.cockos.com/showthread.php?t=176662">Lokasenna’s GUI Tutorial</a></p>

<p><a href="https://www.tutorialspoint.com/lua/">More LUA language resources</a> (don’t bother reading the official docs, they are poorly written.)</p>

<h1 id="conclusion">Conclusion</h1>

<p>That sure ramped up quickly didn’t it. That is kinda how programming works! You start with something small and then you slowly start building on it. Before you know it you have this giant piece of code that spans thousands of lines long and you don’t even realize that you did it.</p>

<p>Don’t be discouraged buy how daunting a project may seem, just start with the smallest thing you can think of and slowly build up from there.</p>

<p>It is quite a bit like music, where you need to just put down one small part and then build on it by adding more parts, and more parts, and more parts. Eventually you go back and you start to remove some things, refine some things and potentially clean up your project to make everything look nice.</p>

<p>If you are a musician, then you can be a programmer. You basically already do the exact same thing anyway!</p>

<h1 id="support-me">Support Me!</h1>

<p>This post took 28 hours to screencast, debug, write and edit. If you appreciate the information presented then <a href="/DonateNow/">please consider joining patreon or paying me for my time spent bringing you quality content!</a></p>

<p><a href="https://www.patreon.com/bePatron?u=7465992"> <img class="patreon-button" src="/assets/Patreon.png" alt="Be a Patreon!" /></a></p>

<form style="text-align: center;" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="BR247JAZBTUJJ" />
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" />
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1" />
</form>

<p><strong>If you have any questions or comments, please comment below! I read every comment and respond to most.</strong> No registration is necessary to comment, so don’t be shy.</p>

:ET